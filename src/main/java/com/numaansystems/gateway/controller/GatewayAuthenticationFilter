package com.example.legacyapp. filter;

import javax.servlet.*;
import javax.servlet.http. HttpServletRequest;
import javax. servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;

public class GatewayAuthenticationFilter implements Filter {

    private String gatewayUrl;
    private List excludedPaths;
    private List excludedExtensions;
    private static final int MAX_AUTH_ATTEMPTS = 3;
    private static final String AUTH_ATTEMPT_COUNT = "authAttemptCount";
    private static final String LAST_AUTH_ATTEMPT_TIME = "lastAuthAttemptTime";
    private static final long AUTH_ATTEMPT_WINDOW_MS = 30000; // 30 seconds

    public void init(FilterConfig filterConfig) throws ServletException {
        gatewayUrl = filterConfig.getInitParameter("gatewayUrl");
        if (gatewayUrl == null || gatewayUrl.isEmpty()) {
            gatewayUrl = "http://localhost:9090/gateway";
        }

        String excludedPathsParam = filterConfig.getInitParameter("excludedPaths");
        if (excludedPathsParam != null && !excludedPathsParam.isEmpty()) {
            excludedPaths = Arrays.asList(excludedPathsParam.split(","));
        } else {
            excludedPaths = Arrays.asList(
                "/auth/callback",
                "/auth/logout",
                "/login.html",
                "/error.html",
                "/public",
                "/resources",
                "/static",
                "/gwt",
                "/css",
                "/js",
                "/images",
                "/fonts",
                "/assets"
            );
        }

        // ADDED: File extensions to exclude from authentication
        String excludedExtensionsParam = filterConfig.getInitParameter("excludedExtensions");
        if (excludedExtensionsParam != null && !excludedExtensionsParam.isEmpty()) {
            excludedExtensions = Arrays. asList(excludedExtensionsParam.split(","));
        } else {
            excludedExtensions = Arrays.asList(
                ".css", ".js", ".png", ".jpg", ".jpeg", ".gif", ".ico", 
                ".svg", ".woff", ".woff2", ". ttf", ".eot", ".map",
                ".html", ".htm"  // Add if you want to exclude all HTML files
            );
        }

        System.out.println("==========================================");
        System.out.println("GatewayAuthenticationFilter INITIALIZED");
        System.out.println("Gateway URL: " + gatewayUrl);
        System.out.println("Excluded Paths: " + excludedPaths);
        System.out.println("Excluded Extensions: " + excludedExtensions);
        System.out.println("Max Auth Attempts: " + MAX_AUTH_ATTEMPTS);
        System.out.println("==========================================");
    }

    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {

        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        HttpSession session = httpRequest. getSession(false);

        String requestURI = httpRequest.getRequestURI();
        String contextPath = httpRequest.getContextPath();
        String path = requestURI.substring(contextPath.length());

        // ADDED: Quick check for static resources by extension
        if (isStaticResource(path)) {
            // Allow static resources without authentication check
            chain.doFilter(request, response);
            return;
        }

        System.out.println("==========================================");
        System.out. println("FILTER - Processing path: " + path);
        System.out.println("FILTER - Full URI: " + requestURI);
        System.out.println("FILTER - Session exists: " + (session != null));
        
        if (session != null) {
            System.out.println("FILTER - Session ID: " + session.getId());
            System.out.println("FILTER - Authenticated: " + session.getAttribute("authenticated"));
            System.out.println("FILTER - Username: " + session.getAttribute("username"));
        }

        // Check if path is excluded from authentication
        if (isExcludedPath(path)) {
            System.out.println("FILTER - Path excluded from authentication: " + path);
            System. out.println("==========================================");
            chain.doFilter(request, response);
            return;
        }

        // Check if user is authenticated
        Boolean authenticated = (session != null) 
            ? (Boolean) session.getAttribute("authenticated") 
            : null;

        if (authenticated == null || !authenticated. booleanValue()) {
            // User not authenticated
            
            // CHECK FOR AUTHENTICATION LOOP
            if (session != null && isAuthenticationLoop(session)) {
                System.err.println("FILTER - AUTHENTICATION LOOP DETECTED!");
                System.err.println("FILTER - Redirecting to error page");
                System.out.println("==========================================");
                
                session.invalidate();
                httpResponse.sendRedirect(contextPath + "/error.html? error=auth_loop");
                return;
            }
            
            // Track authentication attempt
            if (session != null) {
                incrementAuthAttempt(session);
            }
            
            // Build callback URL with context path
            String scheme = httpRequest.getScheme();
            String serverName = httpRequest.getServerName();
            int serverPort = httpRequest.getServerPort();
            
            String portPart = "";
            if ((scheme.equals("http") && serverPort != 80) || 
                (scheme.equals("https") && serverPort != 443)) {
                portPart = ":" + serverPort;
            }
            
            String callbackUrl = scheme + "://" + serverName + portPart + contextPath + "/auth/callback";
            String redirectUrl = gatewayUrl + "/auth/initiate?returnUrl=" 
                + encodeURIComponent(callbackUrl);

            System.out.println("FILTER - User NOT authenticated - redirecting");
            System.out.println("FILTER - Callback URL: " + callbackUrl);
            System.out.println("FILTER - Redirect URL: " + redirectUrl);
            System.out.println("==========================================");
            
            httpResponse.sendRedirect(redirectUrl);
            return;
        }

        // User is authenticated - reset attempt counter
        if (session != null) {
            session.removeAttribute(AUTH_ATTEMPT_COUNT);
            session.removeAttribute(LAST_AUTH_ATTEMPT_TIME);
        }

        System.out.println("FILTER - User IS authenticated: " + session.getAttribute("username"));
        System.out.println("FILTER - Allowing request to proceed");
        System.out. println("==========================================");
        chain.doFilter(request, response);
    }

    public void destroy() {
        System. out.println("GatewayAuthenticationFilter destroyed");
    }

    /**
     * ADDED: Check if the request is for a static resource (CSS, JS, images, etc.)
     */
    private boolean isStaticResource(String path) {
        if (path == null || path.isEmpty()) {
            return false;
        }
        
        // Check file extension
        for (int i = 0; i < excludedExtensions.size(); i++) {
            String extension = ((String) excludedExtensions.get(i)).trim(). toLowerCase();
            if (path. toLowerCase().endsWith(extension)) {
                return true;
            }
        }
        
        return false;
    }

    /**
     * Check if the path is excluded from authentication
     */
    private boolean isExcludedPath(String path) {
        for (int i = 0; i < excludedPaths.size(); i++) {
            String excludedPath = ((String) excludedPaths.get(i)).trim();
            if (path.startsWith(excludedPath)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Check if we're in an authentication loop
     */
    private boolean isAuthenticationLoop(HttpSession session) {
        Long lastAttemptTime = (Long) session.getAttribute(LAST_AUTH_ATTEMPT_TIME);
        Integer attemptCount = (Integer) session. getAttribute(AUTH_ATTEMPT_COUNT);
        
        if (lastAttemptTime == null || attemptCount == null) {
            return false;
        }
        
        long currentTime = System.currentTimeMillis();
        long timeSinceLastAttempt = currentTime - lastAttemptTime. longValue();
        
        if (attemptCount. intValue() >= MAX_AUTH_ATTEMPTS && 
            timeSinceLastAttempt < AUTH_ATTEMPT_WINDOW_MS) {
            System.err.println("FILTER - Loop detection:");
            System.err.println("  Attempts: " + attemptCount);
            System.err.println("  Time since first attempt: " + timeSinceLastAttempt + "ms");
            return true;
        }
        
        if (timeSinceLastAttempt > AUTH_ATTEMPT_WINDOW_MS) {
            session.removeAttribute(AUTH_ATTEMPT_COUNT);
            session.removeAttribute(LAST_AUTH_ATTEMPT_TIME);
            return false;
        }
        
        return false;
    }

    /**
     * Increment authentication attempt counter
     */
    private void incrementAuthAttempt(HttpSession session) {
        Integer attemptCount = (Integer) session.getAttribute(AUTH_ATTEMPT_COUNT);
        Long lastAttemptTime = (Long) session.getAttribute(LAST_AUTH_ATTEMPT_TIME);
        long currentTime = System.currentTimeMillis();
        
        if (attemptCount == null) {
            attemptCount = Integer.valueOf(1);
        } else {
            attemptCount = Integer.valueOf(attemptCount.intValue() + 1);
        }
        
        session.setAttribute(AUTH_ATTEMPT_COUNT, attemptCount);
        session. setAttribute(LAST_AUTH_ATTEMPT_TIME, Long.valueOf(currentTime));
        
        System.out.println("FILTER - Auth attempt #" + attemptCount + " tracked");
    }

    /**
     * URL encode a string (Java 6 compatible)
     */
    private String encodeURIComponent(String s) {
        try {
            return java.net.URLEncoder.encode(s, "UTF-8")
                .replaceAll("\\+", "%20")
                . replaceAll("\\%21", "!")
                .replaceAll("\\%27", "'")
                .replaceAll("\\%28", "(")
                .replaceAll("\\%29", ")")
                .replaceAll("\\%7E", "~");
        } catch (java.io.UnsupportedEncodingException e) {
            return s;
        }
    }
}
